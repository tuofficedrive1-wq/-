<!DOCTYPE html>
<html lang="ur" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ماہانہ مطالعہ اور تحریری کارکردگی</title>
    <!-- Tailwind CSS CDN for responsiveness and modern styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* --- Jameel Noori Nastaliq Font Loading (Web-Compatible) --- */
        @font-face {
            font-family: 'Jameel Noori Nastaleeq';
            src: url('https://cdn.jsdelivr.net/gh/sajjadsaeed/UrduFontsWeb@master/fonts/JameelNooriNastaleeq.woff2') format('woff2');
            font-weight: normal;
            font-style: normal;
            font-display: swap;
        }
        
        body {
            font-family: 'Jameel Noori Nastaleeq', 'Inter', sans-serif;
            background: linear-gradient(135deg, #e0f7fa 0%, #ffffff 100%);
            font-size: 1.3rem; 
        }
        .rtl-text { direction: rtl; }
        
        /* Loading overlay styling - Updated for vertical alignment */
        .loading-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(255, 255, 255, 0.95);
            display: flex;
            flex-direction: column; /* Stack elements vertically */
            justify-content: center;
            align-items: center;
            z-index: 1000;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .loading-overlay.active {
            opacity: 1;
            pointer-events: auto;
        }
        /* Table styling */
        .performance-table input[type="number"] {
            padding: 0.5rem 0.2rem;
            font-size: 1.1rem; 
        }
        .performance-table th, .performance-table td {
            min-width: 60px;
            font-size: 1.1rem; 
        }
        .performance-table thead th {
            background-color: #0d47a1; 
            color: white;
            border: 1px solid #0d47a1;
        }
        
        /* Autocomplete Suggestions */
        .suggestion-item {
            padding: 8px 12px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
            font-size: 1rem; 
        }
        .suggestion-item:hover {
            background-color: #d1e5ff; 
        }
        
        h1 { font-size: 1.5rem; }
        h2 { font-size: 1.25rem; }
        label, input, select, button { font-size: 1.2rem; }

        input:focus, select:focus {
            border-color: #1565c0 !important;
            box-shadow: 0 0 0 2px rgba(21, 101, 192, 0.5);
        }
        
    </style>
</head>
<body class="rtl-text p-2 sm:p-4">

    <div class="max-w-4xl mx-auto bg-white shadow-2xl rounded-2xl p-4 md:p-10 my-4 border-t-4 border-blue-500">
        
        <header class="text-center mb-6 border-b pb-3 border-blue-100">
            <h1 class="text-2xl md:text-3xl font-extrabold text-blue-700 border-b-2 pb-2 border-blue-200">
                ماہانہ مطالعہ اور تحریری کارکردگی
            </h1>
            <p class="text-gray-600 mt-2 text-base">
                براہ کرم تمام معلومات درست اور مکمل فراہم کریں۔
            </p>
        </header>

        <!-- Form Start -->
        <form id="submissionForm" class="space-y-8">

            <!-- General Information Section -->
            <section class="p-4 rounded-xl shadow-lg border border-blue-100 bg-blue-50/50">
                <h2 class="text-xl font-bold text-gray-700 mb-4 border-r-4 pr-2 border-green-600">بنیادی معلومات</h2>
                
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                    
                    <div class="relative">
                        <label for="jameyaName" class="block font-medium text-gray-700 mb-1">جامعۃ المدینہ کا نام:</label>
                        <input type="text" id="jameyaName" name="jameyaName" required class="w-full p-2 border border-gray-300 rounded-lg shadow-sm" placeholder="نام لکھیں یا منتخب کریں">
                        <div id="jamiaSuggestions" class="absolute w-full z-10 bg-white border border-gray-300 rounded-lg shadow-xl mt-1 max-h-48 overflow-y-auto hidden"></div>
                    </div>

                    <div>
                        <label for="zimmadarName" class="block font-medium text-gray-700 mb-1">ذمہ دار نام:</label>
                        <input type="text" id="zimmadarName" name="zimmadarName" required class="w-full p-2 border border-gray-300 rounded-lg shadow-sm">
                    </div>

                    <div>
                        <label for="mahina" class="block font-medium text-gray-700 mb-1">مہینہ:</label>
                        <input type="month" id="mahina" name="mahina" required class="w-full p-2 border border-gray-300 rounded-lg shadow-sm">
                    </div>

                    <div>
                        <label for="rijan" class="block font-medium text-gray-700 mb-1">ریجن:</label>
                        <select id="rijan" name="shoba" required class="w-full p-2 border border-gray-300 rounded-lg shadow-sm">
                            <option value="" disabled selected>ریجن منتخب کریں</option>
                            <option value="اجمیر">اجمیر</option>
                            <option value="دہلی">دہلی</option>
                            <option value="ممبئی">ممبئی</option>
                            <option value="حیدرآباد">حیدرآباد</option>
                            <option value="بینگلور">بینگلور</option>
                            <option value="کلکتہ">کلکتہ</option>
                        </select>
                    </div>
                    
                    <div>
                        <label for="mobileNo" class="block font-medium text-gray-700 mb-1">موبائل نمبر:</label>
                        <input type="tel" id="mobileNo" name="mobileNo" required class="w-full p-2 border border-gray-300 rounded-lg shadow-sm" pattern="[0-9]{10,15}">
                    </div>
                    
                    <div>
                        <label for="totalDarjaat" class="block font-medium text-gray-700 mb-1">کل درجات:</label>
                        <input type="number" id="totalDarjaat" name="totalDarjaat" required min="0" class="w-full p-2 border border-gray-300 rounded-lg shadow-sm">
                    </div>

                    <div>
                        <label for="totalHadaf" class="block font-medium text-gray-700 mb-1">مجموعی ہدف:</label>
                        <input type="number" id="totalHadaf" name="totalHadaf" required min="0" class="w-full p-2 border border-gray-300 rounded-lg shadow-sm" readonly>
                    </div>

                    <div>
                        <label for="totalStudents" class="block font-medium text-gray-700 mb-1">کل طلباء کی تعداد:</label>
                        <input type="number" id="totalStudents" name="totalStudents" required min="0" class="w-full p-2 border border-gray-300 rounded-lg shadow-sm" readonly>
                    </div>
                    
                    <div>
                        <label for="totalMazameen" class="block font-medium text-gray-700 mb-1">کل مضامین:</label>
                        <input type="number" id="totalMazameen" name="totalMazameen" required min="0" class="w-full p-2 border border-gray-300 rounded-lg shadow-sm" readonly>
                    </div>
                    
                    <div class="lg:col-span-1">
                        <label for="totalStudiedPages" class="block font-medium text-gray-700 mb-1">کل مطالعہ صفحات:</label>
                        <input type="number" id="totalStudiedPages" name="totalStudiedPages" required min="0" class="w-full p-2 border border-gray-300 rounded-lg shadow-sm" readonly>
                    </div>
                </div>
            </section>

            <!-- Performance Table Section -->
            <section class="performance-table p-4 rounded-xl shadow-lg border border-green-100 bg-green-50/50">
                <h2 class="text-xl font-bold text-gray-700 mb-4 border-r-4 pr-2 border-blue-600">درجہ وائز کارکردگی کی تفصیلات</h2>
                
                <div class="overflow-x-auto shadow-md rounded-lg border border-gray-200">
                    <table class="min-w-full divide-y divide-gray-200" id="performanceTable">
                        <thead class="sticky top-0">
                            <tr>
                                <th class="px-3 py-2 font-bold tracking-wider text-center">نمبر</th>
                                <th class="px-3 py-2 font-bold tracking-wider text-center">درجہ</th>
                                <th class="px-3 py-2 font-bold tracking-wider text-center">تعداد</th>
                                <th class="px-3 py-2 font-bold tracking-wider text-center">ہدف (صفحات)</th>
                                <th class="px-3 py-2 font-bold tracking-wider text-center">مطالعہ صفحات</th>
                                <th class="px-3 py-2 font-bold tracking-wider text-center">کل مضامین</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200" id="performanceTableBody">
                            <!-- JS se rows ayengi -->
                        </tbody>
                    </table>
                </div>
            </section>
            
            <div class="flex justify-center pt-4">
                <button type="submit" id="submitButton" class="w-full sm:w-auto px-10 py-3 bg-blue-600 text-white font-extrabold text-lg rounded-full shadow-xl hover:bg-blue-700 transition duration-300 transform hover:scale-[1.02] focus:outline-none focus:ring-4 focus:ring-blue-500 focus:ring-opacity-70">
                    رپورٹ جمع کریں
                </button>
            </div>
            
            <p id="responseMessage" class="text-center mt-4 font-semibold hidden p-2 rounded-lg"></p>

        </form>
    </div>

    <!-- Loading Overlay with Book Logo and Durood-e-Pak -->
    <div id="loadingOverlay" class="loading-overlay">
        <!-- Book Logo (SVG) -->
        <div class="mb-4 text-blue-600">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
            </svg>
        </div>
        
        <!-- Spinning Loader -->
        <svg class="animate-spin h-10 w-10 text-blue-600 mb-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>

        <!-- Durood-e-Pak Text -->
        <div class="text-center">
            <p class="text-blue-800 font-bold text-2xl mb-2" style="line-height: 1.6;">
                صَلُّوا عَلَى الحَبِيب !
            </p>
            <p class="text-green-700 font-bold text-xl">
                صَلَّى اللهُ عَلَى مُحَمَّد
            </p>
        </div>
    </div>

    <script>
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyRiGxMXrtnawwmhfJ1ueQo8SiKgx6kBry8M682xqMrOIDILwF-4UYK2SGQWMQ0xD0s/exec'; 
        
        let dataJamia = []; 

        // Darjaat ke makhsoos target aur name
        const darjaat = [
            { display: 'سال اول', nameBase: 'saalawwal', target: 150 }, 
            { display: 'سال دوم', nameBase: 'saaldom', target: 150 }, 
            { display: 'اولیٰ', nameBase: 'oola', target: 450 }, 
            { display: 'ثانیہ', nameBase: 'saniya', target: 450 }, 
            { display: 'ثالثہ', nameBase: 'salisa', target: 600 }, 
            { display: 'رابعہ', nameBase: 'rabia', target: 600 }, 
            { display: 'خامسہ', nameBase: 'khamisa', target: 750 }, 
            { display: 'سادسہ', nameBase: 'sadisa', target: 750 }, 
            { display: 'سابعہ', nameBase: 'sabia', target: 900 }, 
            { display: 'دورہ حدیث', nameBase: 'dorahadees', target: 900 }
        ];

        const tableBody = document.getElementById('performanceTableBody');
        const rijanSelect = document.getElementById('rijan');
        const jameyaNameInput = document.getElementById('jameyaName');
        const jamiaSuggestions = document.getElementById('jamiaSuggestions');
        
        const totalStudentsInput = document.getElementById('totalStudents');
        const totalHadafInput = document.getElementById('totalHadaf'); 
        const totalStudiedPagesInput = document.getElementById('totalStudiedPages');
        const totalMazameenInput = document.getElementById('totalMazameen');

        function updateAllTotals() {
            let tStudents = 0, tHadaf = 0, tSafhat = 0, tMazameen = 0;
            
            document.querySelectorAll('.tadad-input').forEach(i => tStudents += (parseInt(i.value) || 0));
            document.querySelectorAll('.hadaf-input').forEach(i => tHadaf += (parseInt(i.value) || 0));
            document.querySelectorAll('.safhat-input').forEach(i => tSafhat += (parseInt(i.value) || 0));
            document.querySelectorAll('.mazameen-input').forEach(i => tMazameen += (parseInt(i.value) || 0));
            
            totalStudentsInput.value = tStudents;
            totalHadafInput.value = tHadaf;
            totalStudiedPagesInput.value = tSafhat;
            totalMazameenInput.value = tMazameen;
        }

        function handleTadadChange(event) {
            const tadadInput = event.target;
            const row = tadadInput.closest('tr');
            const hadafInput = row.querySelector('.hadaf-input');
            
            const classTarget = parseInt(tadadInput.getAttribute('data-target')) || 0;
            const studentCount = parseInt(tadadInput.value) || 0;
            
            hadafInput.value = studentCount * classTarget;
            
            updateAllTotals();
        }

        async function fetchJamiaData() {
            try {
                jameyaNameInput.placeholder = "Jamia Data load ho raha hai...";
                jameyaNameInput.disabled = true;
                const response = await fetch(SCRIPT_URL);
                dataJamia = await response.json();
                jameyaNameInput.placeholder = "نام لکھیں یا منتخب کریں";
                jameyaNameInput.disabled = false;
            } catch (error) {
                console.error("Error fetching Jamia data:", error);
                jameyaNameInput.placeholder = "Data load nahi ho saka.";
            }
        }
        
        function filterAndShowSuggestions() {
            const selectedRegion = rijanSelect.value;
            const inputText = jameyaNameInput.value.toLowerCase().trim();
            if (!selectedRegion && !inputText) { jamiaSuggestions.classList.add('hidden'); return; }
            const filtered = dataJamia.filter(item => {
                const regionMatch = !selectedRegion || item.region === selectedRegion;
                const inputMatch = item.jamia.toLowerCase().includes(inputText);
                return regionMatch && inputMatch;
            });
            renderSuggestions(filtered);
        }

        function renderSuggestions(suggestions) {
            jamiaSuggestions.innerHTML = '';
            if (suggestions.length === 0) { jamiaSuggestions.classList.add('hidden'); return; }
            suggestions.slice(0, 10).forEach(item => {
                const div = document.createElement('div');
                div.className = 'suggestion-item';
                div.textContent = item.jamia;
                div.onclick = () => {
                    jameyaNameInput.value = item.jamia;
                    jamiaSuggestions.classList.add('hidden');
                    jameyaNameInput.blur(); 
                };
                jamiaSuggestions.appendChild(div);
            });
            jamiaSuggestions.classList.remove('hidden');
        }
        
        document.addEventListener('click', (e) => {
            if (e.target !== jameyaNameInput && !jamiaSuggestions.contains(e.target)) {
                jamiaSuggestions.classList.add('hidden');
            }
        });
        
        rijanSelect.addEventListener('change', filterAndShowSuggestions);
        jameyaNameInput.addEventListener('input', filterAndShowSuggestions);
        jameyaNameInput.addEventListener('focus', filterAndShowSuggestions);
        
        window.onload = () => {
            fetchJamiaData();
            darjaat.forEach((darja, index) => {
                const row = tableBody.insertRow();
                row.className = 'hover:bg-gray-50';
                const base = darja.nameBase;
                row.innerHTML = `
                    <td class="px-3 py-3 text-base text-gray-900 font-medium text-center">${index + 1}</td>
                    <td class="px-3 py-3 text-base text-gray-900 font-medium">${darja.display}</td>
                    <td class="px-3 py-3"><input type="number" id="${base}_tadad" name="${base}_tadad" data-target="${darja.target}" min="0" class="w-full text-center p-1 border border-gray-300 rounded focus:border-blue-500 shadow-sm tadad-input"></td>
                    <td class="px-3 py-3"><input type="number" id="${base}_hadaf" name="${base}_hadaf" min="0" class="w-full text-center p-1 border border-gray-300 rounded focus:border-blue-500 shadow-sm hadaf-input"></td>
                    <td class="px-3 py-3"><input type="number" id="${base}_safhat" name="${base}_safhat" min="0" class="w-full text-center p-1 border border-gray-300 rounded focus:border-blue-500 shadow-sm safhat-input"></td>
                    <td class="px-3 py-3"><input type="number" id="${base}_mazameen" name="${base}_mazameen" min="0" class="w-full text-center p-1 border border-gray-300 rounded focus:border-blue-500 shadow-sm mazameen-input"></td>
                `;
            });

            document.querySelectorAll('.tadad-input').forEach(input => input.addEventListener('input', handleTadadChange));
            document.querySelectorAll('.hadaf-input, .safhat-input, .mazameen-input').forEach(input => input.addEventListener('input', updateAllTotals));
        }
        
        const form = document.getElementById('submissionForm');
        const submitButton = document.getElementById('submitButton');
        const loadingOverlay = document.getElementById('loadingOverlay');
        const responseMessage = document.getElementById('responseMessage');

        form.addEventListener('submit', async function(e) {
            e.preventDefault();
            submitButton.disabled = true;
            loadingOverlay.classList.add('active');
            responseMessage.className = 'hidden';

            const formData = new FormData(form);
            try {
                const response = await fetch(SCRIPT_URL, { method: 'POST', body: formData });
                const data = await response.json();
                if (data.result === 'success') {
                    responseMessage.textContent = 'آپ کی رپورٹ مجلس ماہانہ مطالعہ اور تحریری کارکردگی کے پاس کامیابی کے ساتھ جمع ہو گئی ہے۔';
                    responseMessage.className = 'text-center mt-4 font-semibold text-green-600 block bg-green-100 p-3 rounded-lg shadow';
                    form.reset();
                    updateAllTotals();
                } else {
                    throw new Error(data.message);
                }
            } catch (error) {
                responseMessage.textContent = 'Error: ' + error.message;
                responseMessage.className = 'text-center mt-4 font-semibold text-red-600 block bg-red-100 p-3 rounded-lg shadow';
            } finally {
                submitButton.disabled = false;
                loadingOverlay.classList.remove('active');
            }
        });
    </script>
</body>
</html>
